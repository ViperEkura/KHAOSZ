![image-20250306182014120](assets/png/image-20250306182014120.png)

# KHAOSZ

è¿™æ˜¯ä¸€ä¸ªæ”¯æŒä¸­æ–‡å’Œè‹±æ–‡åŒè¯­è¨€çš„Transfomeræ¨¡å‹ï¼ŒåŒ…å«æ¨¡å‹è®¾ç½®å’Œè®­ç»ƒæµç¨‹ï¼Œ é€šè¿‡åŠ è½½`params/config.json` ä¸­çš„è®¾å®šçš„å‚æ•°å®Œæˆè®­ç»ƒï¼Œ ä½¿ç”¨`train.py`è§£æå‘½ä»¤è¡Œå‚æ•°ï¼ŒåŒ…æ‹¬æ•°æ®é›†æ ¹ç›®å½•ã€è®­ç»ƒè½®æ•°ã€æ‰¹å¤„ç†å¤§å°ã€ä¿å­˜æ£€æŸ¥ç‚¹çš„é—´éš”è½®æ•°ä»¥åŠæ£€æŸ¥ç‚¹ä¿å­˜ç›®å½•ã€‚

æ¨¡å‹çš„å‚æ•°ä¸‹è½½é“¾æ¥ï¼šhttps://huggingface.co/ViperEk/KHAOSZ

æ¼”ç¤ºè§†é¢‘é“¾æ¥ï¼šhttps://www.bilibili.com/video/BV1z5RPYHEkd

è®­ç»ƒæ•°æ®é›†æ¥æºåœ¨æ¨¡å‹çš„å‚æ•°ä¸‹è½½é“¾æ¥ä¸­æ³¨æ˜ï¼Œè‹¥è¦ä½¿ç”¨æ¨¡å‹è¯·ä¸‹è½½åå°†å‚æ•°æ”¾ç½®äº params ç›®å½•

ä»£ç éµå¾ª http://www.apache.org/licenses/LICENSE-2.0 åè®®ï¼Œ ä½¿ç”¨æ—¶è¯·æ³¨æ˜ä»£ç æ¥æº

- **ğŸ“Šè®¾å¤‡é€‰æ‹©**ï¼šå½“å‰ä»£ç é»˜è®¤ä½¿ç”¨CUDAè¿›è¡Œè®­ç»ƒ
- **ğŸŒæ€§èƒ½ä¼˜åŒ–**ï¼šä»£ç ä¸­è®¾ç½®äº†`dtype=torch.bfloat16`æ¥å¯ç”¨è®­ç»ƒï¼Œè¿™æœ‰åŠ©äºæé«˜è®­ç»ƒé€Ÿåº¦å’Œé™ä½æ˜¾å­˜æ¶ˆè€—ï¼Œä½†éœ€ç¡®ä¿ç¡¬ä»¶æ”¯æŒæ­¤ç‰¹æ€§ã€‚
- **ğŸ¤–è¯­è¨€æ”¯æŒ**ï¼šè¯¥æ¨¡å‹ç›®å‰æ”¯æŒåœ¨ä¸­æ–‡å’Œè‹±æ–‡æ•°æ®é›†ä¸Šè®­ç»ƒï¼Œ åœ¨è®­ç»ƒåˆ†è¯å™¨æ—¶æ²¡æœ‰åŠ å…¥å…¶ä»–è¯­è¨€çš„æ–‡æœ¬ï¼ŒBBPEåˆ†è¯å™¨ä¸ä¼šå­˜åœ¨OOVé—®é¢˜ï¼Œä½†æ˜¯å¯¹åˆ«çš„è¯­è¨€æ”¯æŒæ¯”è¾ƒå·®

## ğŸ“Œå¦‚ä½•è®­ç»ƒ

è¦è®­ç»ƒè¿™ä¸ªTransformeræ¨¡å‹ï¼Œæ‚¨å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œæ“ä½œï¼š

**(1). å‡†å¤‡æ•°æ®é›†ï¼š**

ç¡®ä¿æ‚¨çš„æ•°æ®é›†ä½äºä¸€ä¸ªæŒ‡å®šçš„æ ¹ç›®å½•ä¸‹ã€‚æ•°æ®é›†åº”åŒ…å«ç”¨äºè®­ç»ƒçš„æ–‡æœ¬æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶å¯ä»¥æ˜¯ä¸­æ–‡ã€è‹±æ–‡æˆ–ä¸¤è€…æ··åˆã€‚
æ•°æ®æ–‡ä»¶çš„æ ¼å¼åº”ä¸æ¨¡å‹çš„è¾“å…¥è¦æ±‚ä¸€è‡´ï¼Œæœ€å¥½æ˜¯ç»è¿‡tokenizerå¤„ç†è¿‡åçš„token_id, ä¸ºäº†èŠ‚çœå†…å­˜å ç”¨é‡‡ç”¨torch.Tensor å­˜å‚¨id,(å¦‚æœä½¿ç”¨pythonçš„list, åœ¨è¯»å–è®­ç»ƒæ•°æ®çš„æ—¶å€™å†…å­˜å ç”¨å¤§æ¦‚æ˜¯åŸæ¥çš„ä¸¤å€ä»¥ä¸Šï¼Œå› ä¸ºpythonä¼¼ä¹æ˜¯é»˜è®¤é‡‡ç”¨64ä½æ•°ç²¾åº¦å­˜å‚¨çš„æ•°æ®ï¼Œ ä½†æ˜¯å®é™…ä¸Šint32è¶³å¤Ÿ)

**(2).å®‰è£…ä¾èµ–ï¼š**

ç¡®ä¿æ‚¨å·²ç»å®‰è£…äº†æ‰€æœ‰å¿…è¦çš„Pythonåº“ï¼š

```bash
conda env create -f environment.yml --name env_name
```

**(3).è¿è¡Œè®­ç»ƒè„šæœ¬ï¼š**

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è¿è¡Œè®­ç»ƒè„šæœ¬ï¼Œå¹¶æ ¹æ®éœ€è¦è°ƒæ•´å‚æ•°ï¼š

```bash
python train.py \
--train_type=train_type[seq, sft, dpo] \
--data_root_path=/path/to/dataset \
--n_epoch=5 \
--batch_size=8 \
--max_lr=2e-4 \
--n_iter_ckpt=10000 \
--ckpt_dir checkpoints 
```
--train_type: æŒ‡å®šè®­ç»ƒçš„ç±»å‹ï¼Œå¯é€‰å€¼æœ‰seq, sft, dpo

--data_root_pathï¼šæŒ‡å®šæ•°æ®é›†çš„æ ¹ç›®å½•è·¯å¾„ã€‚

--n_epochï¼šæŒ‡å®šè®­ç»ƒçš„æ€»è½®æ•°ã€‚

--batch_sizeï¼šæŒ‡å®šæ¯ä¸ªæ‰¹æ¬¡çš„æ ·æœ¬æ•°é‡ã€‚

--n_iter_stepï¼š å¤šå°‘batchè¿­ä»£ä¸€æ­¥

--warning_step: é¢„çƒ­æ­¥æ•°

--max_lr: æŒ‡å®šè¿‡ç¨‹ä¸­æœ€å¤§çš„å­¦ä¹ ç‡ï¼ˆå­¦ä¹ ç‡é‡‡ç”¨çš„æ˜¯é¢„çƒ­ + ä½™å¼¦è¡°å‡ï¼‰

--n_iter_ckptï¼šæŒ‡å®šæ¯å¤šå°‘è¿­ä»£æ¬¡æ•°ä¿å­˜ä¸€æ¬¡æ£€æŸ¥ç‚¹ã€‚

--ckpt_dirï¼šæŒ‡å®šä¿å­˜æ£€æŸ¥ç‚¹çš„ç›®å½•ã€‚

--resume_dir: æ¢å¤è®­ç»ƒçš„checkpointè·¯å¾„

è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ‚¨å¯ä»¥åœ¨ç»ˆç«¯ä¸­æŸ¥çœ‹è®­ç»ƒæ—¥å¿—(train_log.txt)ï¼Œäº†è§£è®­ç»ƒè¿›åº¦ã€æŸå¤±å€¼ç­‰ä¿¡æ¯ã€‚
æ£€æŸ¥ç‚¹æ–‡ä»¶ä¼šä¿å­˜åœ¨æŒ‡å®šçš„æ£€æŸ¥ç‚¹ç›®å½•ä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨è¿™äº›æ£€æŸ¥ç‚¹æ–‡ä»¶æ¥æ¢å¤è®­ç»ƒæˆ–è¿›è¡Œè¯„ä¼°ã€‚


## ğŸ‘‰å¦‚ä½•ä½¿ç”¨

**(1).ä½¿ç”¨æ¨¡å‹å®ŒæˆèŠå¤©ï¼š**

å¦‚æœæ‚¨æƒ³ä½¿ç”¨è¿™ä¸ªæ¨¡å‹è¿›è¡Œå¯¹è¯èŠå¤©, è¯·æ‰“å¼€ chat.py æ–‡ä»¶ï¼Œå¹¶è¿è¡Œå®ƒã€‚
æˆ–è€…ï¼Œ æ‚¨å¯ä»¥ä½¿ç”¨æµå¼è¾“å‡ºæ¥å£/å¯¹è¯ç”Ÿæˆæ¥å£å®Œæˆå¯¹è¯

```python
from module import Khaosz

model = Khaosz("params")
model = model.to(device='cuda', dtype=torch.bfloat16)
histroy = []

while True:
    query = input(">> ")
    if query == "!exit":
        break
    
    response_size = 0
    for response, histroy in model.stream_generate(
        query=query, 
        history=histroy,
        temperature=0.85,
        top_p=0.95,
        top_k=50
    ):
        print(response[response_size:], end="")
        response_size = len(response)       

```

æˆ–è€…æ‚¨å¯ä»¥ä½¿ç”¨éæµå¼è¾“å‡ºçš„æ–¹å¼å®Œæˆå¯¹è¯

```python
from module import Khaosz

model = Khaosz("params")
model = model.to(device='cuda', dtype=torch.bfloat16)
histroy = []

while True:
    query = input(">> ")
    if query == "!exit":
        break
    
    response_size = 0
    response =  model.generate(
        query=query, 
        history=histroy,
        temperature=0.85,
        top_p=0.95,
        top_k=50
    )
    print(response)
```

**(2) ä½¿ç”¨æ¨¡å‹å®Œæˆå‘é‡æ£€ç´¢ç”Ÿæˆ(RAG)ï¼š**

å¦‚æœæ‚¨æƒ³å¯¹æ–‡æœ¬è¿›è¡Œåˆ†æ®µå¤„ç†

```python
from module import Khaosz

model = Khaosz("params")
model = model.to(device='cuda', dtype=torch.bfloat16)

chunks = model.chunk(text, threshold=0.8, window_size=2)
print(chunks)
```

å¦‚æœæ‚¨æƒ³åœ¨æ–‡æœ¬åˆ†æ®µä¹‹åè¿›è¡Œæ£€ç´¢

```python
from module import Khaosz

model = Khaosz("params")
model = model.to(device='cuda', dtype=torch.bfloat16)

res_embs = [model.sentence_embedding(text) for text in res]
for sentence, emb in zip(res, res_embs):
    model.retriever.add_vector(sentence, emb)

retrive_content = model.retrieve_generate(
    query=query,
    retrive_top_k=5,
    temperature=0.6,
    top_k=30,
    top_p=0.95
)
print(retrive_content)
```


## ğŸ“Œå…¶ä»–é—®é¢˜
æœ¬æ¨¡å‹åŸºäº20å±‚çš„transformerï¼Œå‚æ•°å¤§è‡´è®¾ç½®å¦‚`config.json`ï¼Œå‚æ•°å¤§å°ä¸º4äº¿ï¼ˆ0.40bï¼‰

æ¨¡å‹é‡‡ç”¨æƒé‡ç»‘å®šï¼Œ embeddingå±‚çš„æƒé‡å’Œæœ€åçº¿æ€§å±‚çš„æƒé‡æ˜¯å…±äº«çš„ï¼ˆæ¯”è¾ƒå°çš„æ¨¡å‹éƒ½é‡‡ç”¨è¿™ç§æ–¹å¼èŠ‚çœå‚æ•°å¤§å°ï¼Œ å› ä¸ºä¸é‡‡ç”¨æƒé‡ç»‘å®šï¼Œ embeddingå±‚å‡è®¾æœ‰10000å•è¯ï¼Œ å°†ä¼šå ç”¨ 10000 * 1024 = 102,400,000 å‚æ•°ï¼Œ ä¹Ÿå°±æ˜¯ 0.1b å‚æ•°ï¼Œ å› ä¸ºè¯è¡¨ä¼šå ç”¨å¤ªå¤šçš„å‚æ•°ï¼Œ æ‰€ä»¥é‡‡ç”¨æƒé‡ç»‘å®šæ˜¯å°æ¨¡å‹çš„é€šç”¨æ–¹æ³•ï¼‰

ç”±äºæ¨¡å‹å‚æ•°ç›¸å¯¹è¾ƒå°‘ï¼Œåœ¨æŸäº›ä»»åŠ¡ä¸Šå¯èƒ½ä¼šå‡ºç°æ€§èƒ½ä¸è¶³çš„æƒ…å†µï¼Œæ¯”å¦‚å¯¹å¤æ‚è¯­è¨€ç°è±¡çš„ç†è§£èƒ½åŠ›å¯èƒ½ä¸å¦‚æ›´å¤§è§„æ¨¡çš„æ¨¡å‹ã€‚æ­¤å¤–ï¼Œè¾ƒå°çš„æ¨¡å‹ä¹Ÿå¯èƒ½æ›´å®¹æ˜“è¿‡æ‹Ÿåˆè®­ç»ƒæ•°æ®ï¼Œå¯¼è‡´æ³›åŒ–èƒ½åŠ›è¾ƒå·®ã€‚ä¸è¿‡ï¼Œè¿™ä¹Ÿæ„å‘³ç€è¯¥æ¨¡å‹å¯ä»¥åœ¨è¾ƒä½é…ç½®çš„ç¡¬ä»¶ä¸Šè¿è¡Œï¼Œå¹¶ä¸”è®­ç»ƒæ—¶é—´ç›¸å¯¹è¾ƒçŸ­ã€‚

ç›®å‰æ¨¡å‹å·²ç»å®Œæˆ pre-train + SFT + DPO çš„æµç¨‹ï¼Œ ç›¸åº”çš„è®­ç»ƒä»£ç ä¹Ÿå­˜å‚¨åœ¨äº†é¡¹ç›®å½“ä¸­